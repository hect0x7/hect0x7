name: generate animation

on:
  # run automatically every 24 hours
  schedule:
    - cron: "0 */24 * * *"

  # allows to manually run the job at any time
  workflow_dispatch:

  # run on every push on the master branch
  push:
    branches:
      - master

jobs:
  # generate many small cards in parallel using a matrix
  generate-cards:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - id: stats-light
            card: stats
            options_suffix: "&show_icons=true"
            path: profile/stats-light.svg
          - id: stats-dark
            card: stats
            options_suffix: "&show_icons=true&theme=radical"
            path: profile/stats-dark.svg
          - id: top-langs-light
            card: top-langs
            options_suffix: "&layout=compact&langs_count=6&line_height=25"
            path: profile/top-langs-light.svg
          - id: top-langs-dark
            card: top-langs
            options_suffix: "&layout=compact&langs_count=6&line_height=25&theme=radical"
            path: profile/top-langs-dark.svg
          - id: pin-JMComic-Crawler-Python
            card: pin
            options_suffix: "&repo=JMComic-Crawler-Python&show_owner=true"
            path: profile/pin-JMComic-Crawler-Python.svg
          - id: pin-JMComic-Crawler-Python-dark
            card: pin
            options_suffix: "&repo=JMComic-Crawler-Python&theme=radical&show_owner=true"
            path: profile/pin-JMComic-Crawler-Python-dark.svg
          - id: pin-jmcomic-ai
            card: pin
            options_suffix: "&repo=jmcomic-ai&show_owner=true"
            path: profile/pin-jmcomic-ai.svg
          - id: pin-jmcomic-ai-dark
            card: pin
            options_suffix: "&repo=jmcomic-ai&theme=radical&show_owner=true"
            path: profile/pin-jmcomic-ai-dark.svg
          - id: pin-plugin-jm-server
            card: pin
            options_suffix: "&repo=plugin-jm-server&show_owner=true&description_lines_count=3"
            path: profile/pin-plugin-jm-server.svg
          - id: pin-plugin-jm-server-dark
            card: pin
            options_suffix: "&repo=plugin-jm-server&theme=radical&show_owner=true&description_lines_count=3"
            path: profile/pin-plugin-jm-server-dark.svg
      # 如果并发太多可以开启下面一行限制并发量
      # max-parallel: 4

    steps:
      - uses: actions/checkout@v4

      - name: Generate ${{ matrix.id }}
        uses: readme-tools/github-readme-stats-action@v1
        with:
          card: ${{ matrix.card }}
          options: username=${{ github.repository_owner }}${{ matrix.options_suffix }}
          path: ${{ matrix.path }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload generated card artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.id }}
          path: ${{ matrix.path }}

  # snake generation runs in parallel with the card matrix
  generate-snake:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: generate github-contribution-grid-snake.svg
        uses: Platane/snk/svg-only@v3
        with:
          github_user_name: ${{ github.repository_owner }}
          outputs: |
            dist/github-contribution-grid-snake.svg
            dist/github-contribution-grid-snake-dark.svg?palette=github-dark

      - name: Upload snake dist artifact
        uses: actions/upload-artifact@v3
        with:
          name: snake-dist
          path: dist

  # final job: wait for all generation jobs, download artifacts, commit once and publish dist
  publish:
    needs: [generate-cards, generate-snake]
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v3

      - name: Collect artifacts into repository
        run: |
          mkdir -p profile dist

          # downloaded artifacts appear as ./<artifact-name>/... e.g. ./stats-light/profile/stats-light.svg
          # 把每个 artifact 内的文件拷贝到仓库对应位置（去掉最外层的 artifact 文件夹名）
          find . -type f -name '*.svg' -print0 | while IFS= read -r -d '' file; do
            # remove leading ./ and the first path component (the artifact folder)
            rel="${file#./}"
            rel="${rel#*/}"
            dest="$GITHUB_WORKSPACE/$rel"
            mkdir -p "$(dirname "$dest")"
            cp "$file" "$dest"
          done

      - name: Commit cards
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git add profile/*.svg || true
          git commit -m "Update generated cards" || echo "No changes to commit"
          git push

      - name: Publish dist to output branch
        uses: crazy-max/ghaction-github-pages@v3.1.0
        with:
          target_branch: output
          build_dir: dist
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
